<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityCompass - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-sidebar {
            background-color: #2c3e50;
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
            width: 250px;
        }
        
        .admin-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 5px;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .stats-card {
            text-align: center;
            padding: 20px;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #ffeaa7;
            color: #d35400;
        }
        
        .status-in-progress {
            background-color: #81ecec;
            color: #006266;
        }
        
        .status-resolved {
            background-color: #55efc4;
            color: #005a41;
        }
    </style>
</head>
<body>
    <div id="adminDashboard">
        <div class="admin-sidebar">
            <div class="px-3 mb-4">
                <h4>CityCompass Admin</h4>
                <p class="text-muted small" id="deptName">Loading department...</p>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="fas fa-list me-2"></i> Issues</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="fas fa-chart-bar me-2"></i> Analytics</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="fas fa-users me-2"></i> Department Users</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="fas fa-cog me-2"></i> Settings</a>
                </li>
                <li class="nav-item mt-4">
                    <a class="nav-link" href="#" id="adminLogout"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
                </li>
            </ul>
        </div>
        <div class="admin-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Admin Dashboard</h3>
                <div class="d-flex">
                    <input type="text" class="form-control me-2" placeholder="Search issues...">
                    <button class="btn btn-primary">Search</button>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <i class="fas fa-exclamation-circle fa-2x text-primary"></i>
                        <div class="stats-number" id="totalIssues">0</div>
                        <div class="stats-label">Total Issues</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <i class="fas fa-clock fa-2x text-warning"></i>
                        <div class="stats-number" id="pendingIssues">0</div>
                        <div class="stats-label">Pending Issues</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <i class="fas fa-spinner fa-2x text-info"></i>
                        <div class="stats-number" id="progressIssues">0</div>
                        <div class="stats-label">In Progress</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                        <div class="stats-number" id="resolvedIssues">0</div>
                        <div class="stats-label">Resolved Issues</div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Issues</h5>
                    <div>
                        <select class="form-select form-select-sm" id="statusFilter">
                            <option value="all">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="issuesTableBody">
                                <!-- Issues will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusUpdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Issue Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="statusUpdateForm">
                        <input type="hidden" id="updateIssueId">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="updateStatus" required>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comments</label>
                            <textarea class="form-control" id="updateComments" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitStatusUpdate">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check if user is logged in
        const token = localStorage.getItem('adminToken');
        const department = JSON.parse(localStorage.getItem('adminDepartment') || '{}');
        
        if (!token) {
            window.location.href = '/';
        } else {
            // Display department name
            document.getElementById('deptName').textContent = department.name || 'Department';
        }

        // Logout functionality
        document.getElementById('adminLogout').addEventListener('click', function() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminDepartment');
            window.location.href = '/';
        });

        // Fetch admin data
        async function fetchAdminData() {
            try {
                const response = await fetch('/api/admin/issues', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const issues = await response.json();
                    populateIssuesTable(issues);
                    updateStats(issues);
                } else if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminDepartment');
                    window.location.href = '/';
                } else {
                    console.error('Failed to fetch admin data');
                }
            } catch (error) {
                console.error('Error fetching admin data:', error);
            }
        }

        // Populate issues table
        function populateIssuesTable(issues) {
            const tbody = document.getElementById('issuesTableBody');
            tbody.innerHTML = '';
            
            issues.forEach(issue => {
                const statusClass = issue.status === 'pending' ? 'status-pending' : 
                                  issue.status === 'in-progress' ? 'status-in-progress' : 'status-resolved';
                const statusText = issue.status === 'pending' ? 'Pending' : 
                                 issue.status === 'in-progress' ? 'In Progress' : 'Resolved';
                
                const priorityClass = issue.priority === 'high' ? 'bg-danger' : 
                                    issue.priority === 'medium' ? 'bg-warning' : 'bg-success';
                const priorityText = issue.priority === 'high' ? 'High' : 
                                   issue.priority === 'medium' ? 'Medium' : 'Low';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${issue.id}</td>
                    <td>${issue.category}</td>
                    <td>${issue.title}</td>
                    <td>${issue.location}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><span class="badge ${priorityClass}">${priorityText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-issue" data-id="${issue.id}">View</button>
                        <button class="btn btn-sm btn-outline-success update-status" data-id="${issue.id}">Update</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to update buttons
            document.querySelectorAll('.update-status').forEach(button => {
                button.addEventListener('click', function() {
                    const issueId = this.getAttribute('data-id');
                    document.getElementById('updateIssueId').value = issueId;
                    
                    const modal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));
                    modal.show();
                });
            });
        }

        // Update statistics
        function updateStats(issues) {
            const total = issues.length;
            const pending = issues.filter(issue => issue.status === 'pending').length;
            const progress = issues.filter(issue => issue.status === 'in-progress').length;
            const resolved = issues.filter(issue => issue.status === 'resolved').length;
            
            document.getElementById('totalIssues').textContent = total;
            document.getElementById('pendingIssues').textContent = pending;
            document.getElementById('progressIssues').textContent = progress;
            document.getElementById('resolvedIssues').textContent = resolved;
        }

        // Status update functionality
        document.getElementById('submitStatusUpdate').addEventListener('click', async function() {
            const issueId = document.getElementById('updateIssueId').value;
            const status = document.getElementById('updateStatus').value;
            const comment = document.getElementById('updateComments').value;
            
            try {
                const response = await fetch(`/api/admin/issues/${issueId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status, comment })
                });
                
                if (response.ok) {
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal'));
                    modal.hide();
                    
                    // Show success message
                    alert('Status updated successfully!');
                    
                    // Refresh the data
                    fetchAdminData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status. Please try again.');
            }
        });

        // Status filter functionality
        document.getElementById('statusFilter').addEventListener('change', async function() {
            const status = this.value;
            let url = '/api/admin/issues';
            
            if (status !== 'all') {
                url += `?status=${status}`;
            }
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const issues = await response.json();
                    populateIssuesTable(issues);
                } else {
                    console.error('Failed to filter issues');
                }
            } catch (error) {
                console.error('Error filtering issues:', error);
            }
        });

        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', function() {
            fetchAdminData();
        });
    </script>
</body>
</html>